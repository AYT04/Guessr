<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapillary Guessr</title>
    <!-- MapillaryJS -->
    <script src="https://unpkg.com/mapillary-js@4.1.2/dist/mapillary.js"></script>
    <link href="https://unpkg.com/mapillary-js@4.1.2/dist/mapillary.css" rel="stylesheet" />
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Tailwind for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #mly { width: 100%; height: 100vh; background: #1a1a1a; }
        
        #map { 
            width: 320px; 
            height: 220px; 
            border-radius: 12px; 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            border: 4px solid white; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.6); 
        }
        #map:hover { width: 600px; height: 400px; }
        
        /* Ensure the container itself allows clicks to children */
        .map-container { 
            position: absolute; 
            bottom: 30px; 
            right: 30px; 
            z-index: 1000; 
            pointer-events: auto !important;
        }

        #result-panel { 
            display: none; 
            position: absolute; 
            top: 20px; 
            left: 20px; 
            z-index: 1500; 
            width: 320px;
        }

        .ui-panel { position: absolute; top: 20px; left: 20px; z-index: 1000; pointer-events: none; }
        .ui-element { pointer-events: auto !important; }
        
        #loader {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="bg-zinc-950 text-white overflow-hidden font-sans">

    <!-- Street View Container -->
    <div id="mly"></div>

    <!-- Main Game UI (Top Left) -->
    <div id="game-ui" class="ui-panel space-y-4">
        <div class="ui-element bg-black/70 backdrop-blur-xl p-5 rounded-2xl border border-white/10 shadow-2xl">
            <h1 class="text-2xl font-black tracking-tighter uppercase text-yellow-500">Mapillary Guessr</h1>
            <div id="score-display" class="mt-1 text-xl font-mono font-bold text-white">Score: 0</div>
        </div>
        
        <!-- Token Input -->
        <div id="token-prompt" class="ui-element bg-zinc-900/90 backdrop-blur-md p-6 rounded-2xl border border-yellow-500/30 w-80 shadow-2xl">
            <p class="text-sm font-semibold mb-3 text-zinc-300">Mapillary Access Token Required:</p>
            <input type="text" id="mly-token" placeholder="Paste MLY token here..." class="w-full bg-zinc-800 p-3 rounded-xl text-sm border border-zinc-700 focus:outline-none focus:border-yellow-500 transition-colors">
            <button onclick="startGame()" class="mt-4 w-full bg-yellow-600 hover:bg-yellow-500 py-3 rounded-xl font-black text-sm tracking-widest transition-all transform active:scale-95 shadow-lg">START GAME</button>
            <p class="mt-3 text-[10px] text-zinc-500 leading-tight">Tokens are available for free on the Mapillary Developer Dashboard.</p>
        </div>
    </div>

    <!-- Result Panel -->
    <div id="result-panel" class="ui-element bg-zinc-900/95 backdrop-blur-2xl p-6 rounded-3xl border border-white/10 shadow-2xl ring-1 ring-white/5">
        <h2 id="result-title" class="text-xs font-bold uppercase tracking-[0.2em] text-yellow-500 mb-1">Last Round</h2>
        <div id="result-score" class="text-4xl font-black mb-1">+0</div>
        <p id="result-dist" class="text-sm text-zinc-400 mb-6 font-medium italic"></p>
        
        <button onclick="nextRound()" class="w-full bg-green-600 hover:bg-green-500 py-4 rounded-2xl font-black tracking-widest transition-all transform hover:translate-y-[-2px] active:translate-y-[0] shadow-xl text-sm">
            NEXT ROUND â†’
        </button>
    </div>

    <!-- Guess Map (Bottom Right) -->
    <div class="map-container">
        <div id="map" class="ui-element"></div>
        <button id="guess-btn" onclick="handleGuess()" class="mt-4 w-full bg-blue-600 hover:bg-blue-500 disabled:bg-zinc-800 disabled:text-zinc-600 py-4 rounded-2xl font-black tracking-widest shadow-2xl transition-all transform active:scale-95 disabled:transform-none border-b-4 border-blue-800 disabled:border-zinc-900 ui-element" disabled>
            PLACE GUESS
        </button>
    </div>

    <!-- Loader -->
    <div id="loader">
        <div class="text-center">
            <div class="inline-block w-12 h-12 border-4 border-yellow-500 border-t-transparent rounded-full animate-spin"></div>
            <p class="mt-4 font-black tracking-widest text-sm uppercase">Locating...</p>
        </div>
    </div>

    <script>
        let viewer, map, guessMarker, actualMarker, polyline;
        let currentPos = null;
        let userGuess = null;
        let totalScore = 0;
        let accessToken = "";

        const STARTING_POINTS = [
            { lat: 48.8566, lng: 2.3522 }, { lat: 40.7128, lng: -74.0060 },
            { lat: 52.5200, lng: 13.4050 }, { lat: 35.6762, lng: 139.6503 },
            { lat: -33.8688, lng: 151.2093 }, { lat: 55.6761, lng: 12.5683 },
            { lat: 45.5017, lng: -73.5673 }, { lat: 34.0522, lng: -118.2437 },
            { lat: 51.5074, lng: -0.1278 }, { lat: 41.9028, lng: 12.4964 }
        ];

        function initMap() {
            map = L.map('map', { attributionControl: false }).setView([20, 0], 2);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);

            map.on('click', (e) => {
                if (actualMarker) return; 
                userGuess = e.latlng;
                if (guessMarker) {
                    guessMarker.setLatLng(userGuess);
                } else {
                    guessMarker = L.marker(userGuess).addTo(map);
                }
                
                // Only enable if we have a valid image location loaded
                if (currentPos) {
                    document.getElementById('guess-btn').disabled = false;
                }
            });
        }

        async function findRandomStreetView() {
            document.getElementById('loader').style.display = 'flex';
            currentPos = null; // Reset for new round

            const city = STARTING_POINTS[Math.floor(Math.random() * STARTING_POINTS.length)];
            const lat = city.lat + (Math.random() - 0.5) * 0.15;
            const lng = city.lng + (Math.random() - 0.5) * 0.15;

            const url = `https://graph.mapillary.com/images?access_token=${accessToken}&fields=id,geometry&bbox=${lng-0.02},${lat-0.02},${lng+0.02},${lat+0.02}&limit=1`;

            try {
                const response = await fetch(url);
                const json = await response.json();
                
                if (json.data && json.data.length > 0) {
                    const img = json.data[0];
                    currentPos = { lat: img.geometry.coordinates[1], lng: img.geometry.coordinates[0] };
                    
                    if (!viewer) {
                        viewer = new mapillary.Viewer({ accessToken: accessToken, container: 'mly', imageId: img.id });
                    } else {
                        viewer.moveTo(img.id);
                    }
                    document.getElementById('loader').style.display = 'none';
                } else {
                    findRandomStreetView();
                }
            } catch (err) {
                document.getElementById('loader').style.display = 'none';
                alert("API Error. Check your token.");
            }
        }

        function handleGuess() {
            if (!userGuess || !currentPos) return;

            const actualLatLng = L.latLng(currentPos.lat, currentPos.lng);
            const distance = userGuess.distanceTo(actualLatLng) / 1000; 
            
            const roundScore = Math.max(0, Math.round(5000 * Math.exp(-distance / 2000)));
            totalScore += roundScore;
            
            document.getElementById('score-display').innerText = `Score: ${totalScore}`;
            document.getElementById('result-score').innerText = `+${roundScore}`;
            document.getElementById('result-dist').innerText = `${distance.toFixed(1)} km away`;
            
            actualMarker = L.circleMarker(actualLatLng, { color: '#22c55e', radius: 8, fillOpacity: 1 }).addTo(map);
            polyline = L.polyline([userGuess, actualLatLng], { color: 'white', weight: 3, dashArray: '10, 10', opacity: 0.8 }).addTo(map);
            
            map.fitBounds(polyline.getBounds(), { padding: [40, 40], maxZoom: 12 });

            document.getElementById('game-ui').style.display = 'none';
            document.getElementById('result-panel').style.display = 'block';
            document.getElementById('guess-btn').classList.add('hidden');
        }

        function nextRound() {
            document.getElementById('result-panel').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';
            document.getElementById('guess-btn').classList.remove('hidden');
            document.getElementById('guess-btn').disabled = true;

            if (guessMarker) map.removeLayer(guessMarker);
            if (actualMarker) map.removeLayer(actualMarker);
            if (polyline) map.removeLayer(polyline);
            
            guessMarker = actualMarker = polyline = userGuess = null;
            map.setView([20, 0], 2);
            findRandomStreetView();
        }

        function startGame() {
            accessToken = document.getElementById('mly-token').value.trim();
            if (!accessToken) return;
            document.getElementById('token-prompt').style.display = 'none';
            findRandomStreetView();
        }

        window.onload = initMap;
    </script>
</body>
</html>